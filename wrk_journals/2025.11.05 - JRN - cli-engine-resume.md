# Work Journal - CLI engine resume

## 09:00 Kickoff
- Reviewed post-outage continuation plan in wrk_docs/2025.11.05 - PLN - cli-engine-resume.md.
- Preparing implementation plan; will enumerate actionable tasks.

## 09:30 Baseline verification
- Ran build.bat Debug STRICT=1 and captured output in build_output_latest.txt.
- Exercised CLI validation on FAST.RCD, bad_tt_arrsel.rcd, and Game files\*.RCD; console traces in cli_logs/*.txt and mirrored logs via RCD_CLI_LOG.
- Ran BUILD_GTEST=1 build.bat Debug to confirm gtest restore path; output stored in build_output_gtest_latest.txt.
## 10:00 CLI feature planning
- Designed refactor for RunRcdValidationCli to delegate to a pure helper returning printable lines and overall status.
- Plan to expose helper via new cli_validate.h so GTests can assert on outputs without spawning the GUI binary.
- Will update wildcard handling to include directories, add exception guard returning exit code 3, and refresh documentation for RCD_CLI_LOG (env var only).
## 10:45 CLI implementation
- Refactored src/railui/cli_validate.cpp to share a pure helper (EvaluateRcdValidationForTesting) with tests, added exception guard, and updated wildcard expansion to include directories.
- Added cli_validate.h and exposed helper structs for tests; adjusted MirrorLog handling and ASCII-to-wide conversion.
- Rebuilt GoogleTests (BUILD_GTEST=1 build.bat Debug) to validate the changes and ensure cli suite compiles.
## 11:15 Testing and docs
- Replaced cli validation GTests to consume the new helper, added wildcard directory coverage, and wired src/railui include path into RailCoreTests.vcxproj.
- Documented the env-var-only logging decision in README and the CLI HLD.
## 11:30 CI matrix planning
- Pivoted to plan item 5: extend CLI sanity steps in .github/workflows/msvc.yml to cover Release builds using a matrix.
- Drafted approach: introduce a config matrix (Debug/Release), gate coverage + lint steps to Debug only, and produce per-config CLI log artifacts.
## 12:00 CI matrix implementation
- Updated .github/workflows/msvc.yml to use a Debug/Release matrix so each CLI sanity run exercises both binaries and publishes per-config artifacts.
- Gated lint, coverage, and gtest steps behind matrix.config == Debug while retaining always() guards where needed.
## 12:10 CLI id flag planning
- Targeting plan item 4: expose layout SHA-256 via CLI.
- Approach: add --print-id option to RunRcdValidationCli, reuse Evaluate helper to format `id=<hash>` when validation succeeds, and cover single/multi-file cases in tests.
## 12:45 CLI id flag implementation
- Added CliValidationOptions with --print-id awareness; success lines now optionally append the layout SHA-256 id.
- Updated README and CLI docs, plus gtests for single and multi-file cases using the helper ID computation.
- Rebuilt BUILD_GTEST=1 Debug to confirm the new CLI/test wiring.
## 13:15 Parser fixtures
- Added Game files/bad_routes_missing_stage_tokens.rcd exercising the "expected exactly 6 stage tokens" branch using real data for CLI regressions.
- Verified new sample via railc --rcd-validate to ensure the message remains stable.
## 13:30 Parser fixtures
- Added Game files/bad_routes_unknown_selector.rcd to flag unknown selector references (Route 998).
- Confirmed CLI error output matches parser message for FromSelector mismatch.
## 13:45 Stage telemetry audit
- Inspected ARRIVALS/DEPARTUR rendering paths; still rely on legacy status enums and PTimetableInfo getters with no awareness of stage/stageIndex deltas.
- Traced Expect[] refresh in layout.cpp; route and status fields managed locally without backend snapshots, confirming we need a UI-side adapter to consume Stage metadata.
- Next: map how simulation updates currently enter TLayout (likely via legacy timers) and draft integration plan to surface stage strings/icons.
## 14:00 Stage UI plan
- Authored wrk_docs/2025.11.05 - PLN - stage-progress-ui.md capturing the adapter strategy and UI rendering updates for stage telemetry.
- Next up: start plumbing storage in TLayout and expose getters so Arrivals/Departures can read telemetry when provided.
## 14:30 Stage telemetry UI
- Added stage telemetry storage APIs to TTimetable/TLayout, enabling future controller updates to feed RailCore stage data.
- Arrivals and Departures now append a grey "Stage" string (bucket + section ids) when telemetry is present; layout auto-resize accounts for the new text.
- Rebuilt Debug configuration to confirm compilation.
## 14:45 Resize coalescing
- Added ID_CHILD_RESIZE_COALESCE timer and pending flag so repeated child resizes schedule a single layout pass.
- HandleChildResize now debounces via timer; EvTimer triggers CMOptOptimi when layout is idle.
- Updated constructor/destructor for timer lifecycle; verified with build.bat Debug.
## 15:00 Telemetry fallback refinement
- Updated RefreshLegacyStageTelemetry to skip trains already carrying explicit stage data so controller-fed telemetry can win.
- Added StageTelemetryCache API sketch to the plan doc for future adapter work.
## 15:15 Stage telemetry cache helper
- Added include/railui/stage_telemetry_cache.h and src/railui/stage_telemetry_cache.cpp implementing queue/apply helpers for controller-driven stage updates.
- Wired build scripts to compile the new helper (RailControl.vcxproj/filter entries).
## 15:30 Next backlog planning
- Assessing next steps: need an adapter to feed StageTelemetryCache from simulation ticks.
- Plan: teach HandleTimeChange to accept optional pre-populated cache (no controller yet) by exposing a setter that external code can call before each tick.

## 16:30 Stage telemetry cache integration
- Added `TLayout::SetTimetableStatus` so every timetable status change now queues a `StageTelemetryUpdate` before `HandleTimeChange` flushes the cache.
- Introduced `BuildLegacyStageTelemetry` to translate legacy status codes into stage buckets and reused it inside the fallback path.
- Replaced direct `SetStatus` invocations in layout tracking logic with the helper to keep telemetry in sync with arrivals/departures updates.
