# Rail Control .RCD File Format Guide

This guide reverse-engineers the text format consumed by `TLayout::ReadDataFile` (LAYOUT.CPP:1907+) and cross-checks it with the sample layouts in the repository (FAST.RCD, KINGSX.RCD, WAVERLY88.RCD). Use it when authoring new timetable/simulation files.

## File-Wide Conventions
- Plain ASCII text with CRLF line endings. The loader streams the file via `std::ifstream`, so stray binary bytes will halt parsing.
- Section headers `[NAME]` are case-insensitive. The loader re-reads the file for each section, so order is flexible, but following the canonical sequence below aids review.
- Every required section must appear exactly once. Missing or duplicate sections trigger a modal error and abort loading.
- Fields are comma-separated. Whitespace around commas is ignored. If the final numeric field on a line is omitted, the loader treats it as zero.
- Numeric fields are signed decimal integers. Times are written as 24-hour `HHMM` integers (for example `0645`).
- Comments are only recognised in `[TIMETABLE]` lines: text after `#` is stored as that entry's comment.
- Array sizes are fixed at compile time; exceeding them fails the load.

### Capacity limits
| Structure | Array size | Valid IDs |
|-----------|------------|-----------|
| Sections (`PSectionInfo`) | 1000 | 1-999 |
| Overlap pairs (`POverlapDataInfo`) | 50 | 1-49 |
| Platforms (`PPlatDataInfo`) | 50 | 1-49 |
| Selectors (`PSelectorInfo`) | 50 | 1-49 |
| Routes (`PRoutesInfo`) | 1000 | 1-999 |
| Locomotives (`PLocosInfo`) | 500 | 1-499 |
| Timetable entries (`PTimetableInfo`) | 500 (`MAX_TIMETABLE`) | 1-499 |
| Locoyard slots (`LocoyardLoco`) | 16 | implicit |

## Section Reference
### [GENERAL]
Key-value pairs controlling the session. Required keys:

| Key | Meaning |
|-----|---------|
| `StartTime` | Shift start time (HHMM). Stored internally as packed minutes in `WorkTime`. |
| `StopTime` | Shift end time (HHMM). Must be greater than `StartTime`; used to compute `ShiftLength`. |
| `StartText1`..`StartText3` | Lines shown in the start dialog. Optional; default to empty strings. |
| `DrawSectionNumber` | Optional. `T`/`F`. When `T`, section IDs are painted on the layout for debugging. |
| `DrawSelectorNumber` | Optional. `T`/`F`. When `T`, selector buttons show their numeric ID instead of the label text. |

Any other tokens are ignored. Missing `StartTime`/`StopTime` or inverted times cause a load failure.

### [SECTIONS]
Defines the track polygons used for occupancy and rendering.

Format per line: `SectionID, x1, y1, x2, y2, x3, y3, x4, y4`

- `SectionID` must be unique in 1-999.
- The four coordinate pairs describe a quadrilateral in screen pixels (Borland OWL coordinate space). The loader stores them verbatim; use a consistent winding order.
- Section IDs are referenced by routes, overlaps, selectors (hold point), and timetable logic. Any referenced ID must exist here.

### [OVERLAPPING]
Declares mutually-exclusive sections that must be clear before a route can be set.

Format: `RuleID, SectionA, SectionB`

- `RuleID` 1-49 unique (the ID itself is only used as a lookup slot).
- `SectionA`/`SectionB` reference existing section IDs. Either may be `0` to disable the slot.
- The loader checks these pairs whenever it validates or clears routes.

### [PLATFORMS]
Defines platform polygons and their linkage to selectors/timetables.

Format per line: `PlatformID, x1, y1, x2, y2, x3, y3, x4, y4`

- `PlatformID` 1-49, unique.
- Each platform must later be associated with a selector of type 3 or 4; the loader enforces this after `[SELECTOR]`.

### [SELECTOR]
Defines clickable control buttons (inputs, outputs, platforms, hold point, loco yard).

Format: `SelectorID, X, Y, Width, Height, Type, Reference, Label`

- `SelectorID`: 1-49, unique.
- `X`, `Y`, `Width`, `Height`: window rectangle in pixels.
- `Type`: integer mapped to the constants below.

| Type | Constant | Meaning | Reference field |
|------|----------|---------|-----------------|
| 1 | `SEL_INPUT` | Entry line | Unused (`0`) |
| 2 | `SEL_OUTPUT` | Exit line | Unused |
| 3 | `SEL_PLAT` | Non-electrified platform | Platform ID (1-49) |
| 4 | `SEL_ELECTRIC_PLAT` | Electrified platform | Platform ID (1-49) |
| 5 | `SEL_HOLD` | Hold point selector | Section ID marking the hold block |
| 6 | `SEL_LOCOYARD` | Loco yard selector | Unused |

Additional rules:
- Platform types (3/4) must reference an existing platform; each platform must have exactly one selector (`SetSelectorRef` enforces this).
- The first type-5 selector sets the global hold point and hold section; subsequent duplicates degrade to type 4.
- The first type-6 selector sets the global locoyard selector; later duplicates degrade to type 4.
- `Label` is rendered on the button unless `DrawSelectorNumber=T`, in which case the numeric ID is shown.

### [ROUTES]
Enumerates allowable paths between selectors and the sections that must remain clear.

Format: `RouteID, FromSelector, ToSelector, Clear0, Clear1, Clear2, Clear3, Clear4, Clear5`

- `RouteID`: 1-999, unique.
- `FromSelector`, `ToSelector`: selector IDs defined in `[SELECTOR]`.
- Each `ClearN` encodes up to two section IDs: `value = Primary + 1000 * Secondary`. Example: `56061` means primary section 61, secondary section 56. Use `0` when no section is involved.
- Every referenced section must exist; invalid IDs abort the load.
- The six entries correspond to the arrival/approach stages (`ST_ARRA`..`ST_ARRF`) and, by reuse, the departure stages (`ST_DEPA`..`ST_DEPF`).
- Route availability checks also honour `[OVERLAPPING]` pairs.

### [LOCOS]
Defines the locomotive roster.

Format: `LocoID, Class, Number, StockCode`

- `LocoID`: 1-499, unique.
- `Class`: integer prefix (for example `31`, `254`).
- `Number`: running number (0-999). Leading zeros may be written (`001`).
- `StockCode`: any `SC_*` constant (table below). Every loco starts with flag `LF_UNASSIGN`.

### [LOCOYARD]
Initialises locomotives in the yard or disables the feature.

- If the first line is `Disabled`, the loader sets `LocoyardEnabled = FALSE` and skips the rest of the section.
- Otherwise each line: `StockCode, RefuelOffsetMinutes`
  - `StockCode`: allowed values are 1-6 and 10-12 (ECS, HST, EMU, Deltic, Standard, Relief, Push/Pull, DMU, Class 37). Any other value is ignored.
  - `RefuelOffsetMinutes`: 0-59. The loader calls `AssignYardLoco` at `StartTime + offset`. With refuelling enabled, non-zero offsets mark the loco `LF_REFUEL` until the time elapses.
- Locos are chosen randomly from the pool of free locomotives matching the requested stock code.

### [TIMETABLE]
Defines trains and light-engine moves.

Format:
`EntryID, ArrivalDescription, DepartureDescription, ArrSelector, ArrTime, ReleaseOffset, DepTime, ArrStock, DepStock, Status, Extra, NextEntry # Optional comment`

| Field | Meaning | Validation |
|-------|---------|------------|
| `EntryID` | Timetable ID (1-499). | Must be unique. |
| `ArrivalDescription` | Text shown in arrival lists (trimmed to 24 chars). | Required. |
| `DepartureDescription` | Text shown in departure lists. | Required. |
| `ArrSelector` | Selector where the train appears (`mArrPnt`). | Must reference a selector of type `SEL_INPUT`. |
| `ArrTime` | Scheduled arrival (HHMM). | Minutes must be `<60`. |
| `ReleaseOffset` | Minutes to release stock after arrival (HHMM-style minutes). | Usually `0` if none. |
| `DepTime` | Scheduled departure (HHMM). | Minutes `<60`. |
| `ArrStock` | Incoming stock code (`SC_*`). | Must be valid. |
| `DepStock` | Outgoing stock code. | Must be valid. |
| `Status` | Initial status enum (`ST_*`). | Out-of-range aborts load. |
| `Extra` | Context-sensitive field (see below). | Range depends on `Status`. |
| `NextEntry` | Timetable ID that inherits the loco (`mNextTimeTabPos`). | `0` or an existing entry `<500`. |

Comments:
- Text after `#` is stored as the entry comment (trimmed to 200 chars).
- If the comment contains `Becomes <text>`, the loader verifies `<text>` matches the arrival description of the entry referenced by `NextEntry`.
- Omitting the final numeric field implicitly sets `NextEntry` to `0`.

`Extra` field by status:

| Status | Constant | `Extra` usage |
|--------|----------|----------------|
| `0` | `ST_NONE` | Delay flag (`DLF_*`). |
| `12` | `ST_INPLAT` | Platform ID (1-14) holding the train at start. |
| `14` | `ST_STOCKOK` | Platform ID (1-14) where stock awaits a new loco. |
| `30` | `ST_TWINASSOC` | Timetable ID of the associated twin unit. |
| Others | varies | Typically `0`. |

Status codes (`GENERAL.H`):

| Code | Constant | Meaning |
|------|----------|---------|
| 1 | `ST_DUE` | Due but not yet approaching. |
| 2 | `ST_APPROACH` | Approaching the layout. |
| 3 | `ST_HELD` | Held outside the station. |
| 4-11 | `ST_FIRSTHELD`..`ST_ARRF` | Arrival stages A-F. |
| 12 | `ST_INPLAT` | Train stands in platform at start. |
| 13 | `ST_RELEASE` | Stock released, requires loco. |
| 14 | `ST_STOCKOK` | Stock ready to depart after loco swap. |
| 15 | `ST_READYDEP` | Ready within five minutes of departure. |
| 16-22 | `ST_STARTDEP`..`ST_DEPF` | Departure stages A-F. |
| 30 | `ST_TWINASSOC` | Twin-unit association. |

Delay flags (`DLF_*` when `Status = 0`):

| Code | Constant | Behaviour |
|------|----------|-----------|
| 0 | `DLF_NODELAYS` | No random delay. |
| 1 | `DLF_DELAYS` | Allow early/late variance. |
| 2 | `DLF_DELAYS_MAINT` | Maintenance delay profile. |
| 3 | `DLF_DELAYS_THRU` | Through-service delay profile. |
| 4 | `DLF_ONLYLATE` | Only late running; early arrivals forced on time. |
| 5 | `DLF_ONLYLATE_THRU` | Through-service, no early arrivals. |

Stock codes (`SC_*`):

| Code | Constant | Notes |
|------|----------|-------|
| 1 | `SC_ECS` | ECS set (Class 31). |
| 2 | `SC_HST` | HST set. |
| 3 | `SC_EMU` | EMU set. |
| 4 | `SC_DELTIC` | Deltic express. |
| 5 | `SC_NORMAL` | Standard passenger (Class 40/45/46/47). |
| 6 | `SC_RELIEF` | Relief passenger. |
| 7 | `SC_LIGHTECS` | Light engine for ECS. |
| 8 | `SC_LIGHTNORM` | Light standard engine. |
| 9 | `SC_LIGHTDELT` | Light Deltic. |
| 10 | `SC_PUSHPULL` | Push/pull set (Class 47/7). |
| 11 | `SC_DMU1` | First-generation DMU. |
| 12 | `SC_CLASS37` | Class 37 locomotive. |
| 13 | `SC_LIGHTRLF` | Light relief loco. |
| 14 | `SC_LIGHT37` | Light Class 37. |
| 15 | `SC_HEAVYFREIGHT` | Heavy freight loco. |
| 16 | `SC_DMU156` | Class 156 DMU. |
| 17 | `SC_DMU158` | Class 158 DMU. |
| 18 | `SC_DMU170` | Class 170 DMU. |
| 19 | `SC_TWIN156` | Twin 156 DMU. |
| 20 | `SC_TWIN158` | Twin 158 DMU. |
| 21 | `SC_TWIN170` | Twin 170 DMU. |
| 22 | `SC_DMU150` | Class 150 DMU. |

When `Status` is `ST_INPLAT` or `ST_STOCKOK`, the loader auto-assigns locomotives via `AssignLoco`, links the platform to the timetable entry, and, when the yard is enabled, flags the loco `LF_NEEDFUEL`. Twin-unit departures automatically request two locomotives/sets.

## Building a New .RCD File
1. **Sketch the layout**: assign section IDs and coordinates. Keep polygons consistent and avoid reusing IDs.
2. **Define platforms**: create `[PLATFORMS]` entries aligned to the diagram; record the IDs for selector mapping.
3. **Add selectors**: place input/output buttons, exactly one hold point (type 5), optionally one loco yard (type 6), and platform selectors referencing their platform IDs.
4. **Map overlaps**: list conflicting sections under `[OVERLAPPING]` to enforce block safety.
5. **Describe routes**: for every viable start/end selector pair, add a `[ROUTES]` line with six clearance stages. Use the thousands encoding to list up to two sections per stage; use `0` when unused.
6. **Populate the fleet**: enumerate locomotives under `[LOCOS]` with all stock codes required by the timetable. Ensure there are enough units to satisfy chained workings and yard seeding.
7. **Seed the locoyard**: either write `Disabled` or add `StockCode, Offset` lines for initial yard availability.
8. **Author the timetable**:
   - Work chronologically for readability.
   - Keep `ArrivalDescription` strings consistent; link multi-part workings with `Status = 30` and `Extra` pointing to the partner entry.
   - Fill `NextEntry` for loco handovers and include `# Becomes <ArrivalDescription>` comments to satisfy validation.
   - For trains already in-platform at start, set `Status = 12` or `14` and `Extra` to the platform number.
   - Use `DLF_*` codes when you want random delays.
9. **Complete `[GENERAL]`**: choose start/stop times that span the timetable and populate the start briefing text. Enable the debug flags while testing.
10. **Validate**:
    - Verify every referenced section, selector, platform, route, and timetable ID exists and lies within range.
    - Ensure every platform has a selector (the loader enforces this after `[SELECTOR]`).
    - Confirm all stock codes in `[TIMETABLE]`, `[LOCOS]`, and `[LOCOYARD]` exist in the stock code table.
    - Load the file in Rail Control, review the start dialog, and run through key routes.

## Practical Tips
- The loader reopens the file per section; grouping related content improves readability but is not mandatory.
- Times can roll past midnight; the packing logic (`PackTime`/`NormTime`) handles 24-hour arithmetic, but keep arrival/departure values self-consistent to avoid negative release intervals.
- For light-engine releases, set `DepStock` to a light loco code while leaving `ArrStock` as the incoming consist; the loader handles the swap.
- Temporarily set `DrawSectionNumber`/`DrawSelectorNumber` to `T` while laying out geometry, then reset them to `F` before shipping the scenario.
