# MSVC Migration Update (17 Oct 2025)

## Progress To Date
- **Toolchain & Libraries**: Visual Studio 2022 Community (MSVC 19.44) installed and verified. OWLNext 7.0.19 Win32 static libraries rebuilt with COMPAT=5 using the updated uild\msvc\build_owlnext_msvc.bat helper.
- **Project Scaffolding**: Added uild_msvc.bat, generated uild/msvc/RailControl.sln/.vcxproj/.filters, and converted .github/workflows/msvc.yml into a working (allowed-to-fail) MSVC build job. All legacy sources/resources are represented and linked against the new OWLNext libs.
- **Core Porting Work**:
  - Refreshed classdef.h, ctl3d.h, and the entire window hierarchy to use OWLNext 7 APIs (e.g., GetWindowClassName, owl::uint, modern include paths).
  - Replaced Borland-only helpers (MakeWindow, ExecDialog, LoadBitmap, andomize, sndPlaySound, etc.) with Win32/OwlNext equivalents; dialogs now call Execute(), and resources load via GetModule()->GetHandle().
  - Modernized string/stream handling (std::istringstream, _itoa_s, const-safe TTimetable) and templated constructors.
  - Updated audio/resource handling (PlaySound, ::LoadBitmap, ::LoadIcon), stubbed the legacy ctl3d API, and seeded the RNG with srand(time(0)).
  - MSVC now compiles through most modules; OWLNext compatibility macros (OWL5_COMPAT, etc.) are in place and no longer trip build errors.

## Outstanding Items
- **Event Handlers**: Remaining CheckSignature/override errors stem from const-qualified handler signatures (EvLButtonDown, EvSize, EvMove, etc.). These need to match OWLNext’s expected prototypes (non-const references) or drop override where inheritance doesn’t apply.
- **Layout Parser & Dialog Helpers**: Replace the lingering Win32 structures and parsing utilities:
  - Initialize OPENFILENAME with modern defaults (ZeroMemory, GetOpenFileNameW if UNICODE) and ensure commdlg.h is included.
  - Validate the std::ifstream usage introduced in Layout (declare std::ifstream infile(...) before using) and confirm _itoa_s replacements compile.
  - Update any remaining GetApplication()->LoadString calls (already switched to ::LoadString).
- **Audio**: Ensure PlaySound usage has the correct flags and winmm.lib remains linked via the project.
- **Remaining Win16 Aliases**: Continue removing macros like the temporary #define HWindow GetHandle() by rewriting dependent code (GetHandle() directly, InvalidateRect(GetHandle(), ...), etc.).

## Next Steps
1. Finalize handler signature adjustments across all derived windows (TArrivals, TDepartur, TLocoyard, TPlatform, TSelector, TToolbutton, TMainWindow, etc.) so OWLNext’s response-table checks pass.
2. Complete Layout’s data/file modal code: replace the cloned Borland parsing with standard C++ streams (already partially done), confirm TTimetable construction compiles, and handle the LoadString/message-box calls with explicit GetHandle().
3. Replace the remaining sndPlaySound call (now PlaySound) with robust error handling or consider stubbing if audio is optional.
4. Once compilation succeeds, tighten CI (make the MSVC job required) and execute manual smoke tests using the new executable.

_Updated: 17 Oct 2025_
