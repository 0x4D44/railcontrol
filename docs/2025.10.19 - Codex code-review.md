# Rail Control Codebase Review — 19 Oct 2025

## Executive Summary
Rail Control ships a substantial OWL-based Win32 application that still reflects its Borland C++ roots. Core gameplay logic and UI plumbing are intact, but several high-risk defects surfaced during review—most notably in locomotive assignment and window class registration. Modern Windows compatibility is also fragile because the app still relies on WinHelp `.hlp` assets and writes configuration directly to the Windows directory.

## High-Severity Findings
1. **Multiple defects in `AssignLoco` lead to overflow and inconsistent state** (`LAYOUT.CPP:3114-3210`)
   - The `FreeLoco` scratch array is declared as `int FreeLoco[100]`, but the loop writes to index 100 before clamping (`FreeLoco[a] = z; if (a < 100) a++;`). With =101 eligible locos the code walks off the end of the buffer, corrupting heap memory.
   - When assigning twin sets (`SC_TWIN*`), the code always marks `mLoco[0]` as `LF_ASSIGNED` (`GetLoco()`), leaving the second unit flagged `LF_UNASSIGN`. That locomotive can be re-issued elsewhere, so the simulation silently duplicates motive power.
   - The “no stock available” branch only compiles when `MDDEBUG` is defined (`general.h:209`). In release builds the function simply returns `TRUE`, even though no loco was attached, which propagates zero IDs through the rest of the control logic.
   - **Recommendation:** Guard the array push (`if (a < std::size(FreeLoco)) FreeLoco[a++] = z;`), set `SetFlag` against `GetLoco(lii)`, and make the error path unconditional (return `FALSE` + surface UI state).

2. **Toolbar window class registered with logical OR instead of bitwise OR** (`TOOLBUTT.CPP:145-151`)
   - `WndClass.style = CS_HREDRAW || CS_VREDRAW;` collapses to `1`, so `CS_HREDRAW` is never set. Resizing or invalidating a toolbar button can leave stale visuals because horizontal redraws are skipped.
   - **Recommendation:** switch to `WndClass.style = CS_HREDRAW | CS_VREDRAW;`.

3. **Help system is tied to WinHelp, which no longer ships with Windows** (`RAILC.CPP:1360-1373`, `CLASSDEF.H:32-34`)
   - Both Help menu entries invoke `::WinHelp` against `RAILC.HLP`. Microsoft removed WinHelp support after Windows 7; on current machines those calls fail silently. Pressing F1 or opening contents delivers no assistance.
   - **Recommendation:** migrate to HTML Help (`HtmlHelpA/W`) or ship an embedded viewer (e.g., CHM, web-based help).

4. **Configuration persistence still targets the Windows directory** (`CLASSDEF.H:30-34`, `RAILC.CPP:500-548`)
   - `INIFILENAME` is the bare filename `RAILC.INI`, so `WritePrivateProfileString` writes to `%WINDIR%`. On Windows Vista+ that location is protected; attempts fail (or get virtualised per-user), making user preferences appear to “forget” randomly.
   - **Recommendation:** resolve the INI path to a writable location (e.g., `%LOCALAPPDATA%\RailControl\railc.ini`) and check return values for failures.

## Medium-Severity & Maintainability Observations
- **Hard-coded diagnostic log path** (`LAYOUT.CPP:432-470`, `3950-3956`): Logs always target `c:\language\railcontrol\ptrack_debug.log`. On installations elsewhere or with limited write access the `fopen` calls fail silently, defeating the diagnostics and wasting I/O. Prefer deriving the log location from the executable directory or user profile, and consider guarding the logging behind a compile-time flag.
- **Section-number overlay assumes section #1 exists** (`LAYOUT.CPP:964-982`): `DrawSection` fetches geometry from `PSectionInfo[1]` to size the font. If a layout omits section 1, enabling `mDrawSectionNumber` dereferences `nullptr`. The helper should fall back to the current section instead.
- **Legacy dependencies and character set**: The project is locked to ANSI APIs (`char`, `LPSTR`) and Borland-era OWLNext headers. Unicode filenames, high DPI, and IME scenarios will misbehave. Planning a Unicode/modern SDK migration would remove a class of subtle bugs.
- **Global feature flags**: Many behaviours hinge on globals such as `LocoyardEnabled`, `SelectEnable`, etc. Without clearer ownership or RAII, future feature work risks regressions.

## Modernisation / Technical Debt Opportunities
- Encapsulate GDI handles (`HBRUSH`, `HPEN`, `HFONT`) with RAII wrappers to avoid manual `DeleteObject` scattered across destructors.
- Replace bespoke INI parsing with a structured config (JSON, YAML) so validation and defaults are centralised.
- Introduce automated tests around timetable parsing and loco assignment; current logic is both complex and brittle.
- Add a lightweight logging abstraction instead of ad hoc `fopen/fprintf` blocks.

## Suggested Next Steps
1. Patch `AssignLoco` to eliminate the overflow, correctly flag every allocated locomotive, and expose failure paths.
2. Fix the toolbar class registration (one-line change) and audit for other `||` versus `|` mistakes.
3. Decide on a modern help-delivery mechanism and retire WinHelp assets.
4. Relocate configuration + diagnostics into user-writable directories and verify persistence on a standard Windows 11 machine.
5. Create regression scenarios (or manual scripts) that cover twin-set assignment and high locomotive counts to confirm behaviour after fixes.
