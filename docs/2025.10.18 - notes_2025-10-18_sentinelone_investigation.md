# SentinelOne Investigation Notes — 2025-10-18

## Context
- Repository: `C:\language\railcontrol`
- Modernizing and validating `railc_msvc.exe` (MSVC Win32 build) after numerous string-handling and geometry updates.
- Blocking issue: immediate crash on startup inside `owl::TWindow::PerformSetupAndTransfer`, suspected SentinelOne interference.

## Work Completed
1. **Baseline validation**
   - Rebuilt MSVC Debug target (`build_msvc.bat Debug`) to confirm clean build/pdbs.
   - Captured initial crash traces (`cdb_capture.log`, `cdb_vtable.log`) showing access violation when OR-ing `[esi+0x70]`, with `esi` pointing into `ntdll.dll`.

2. **Deep-dive debugger sessions**
   - Added scripted runs (`cdb_cmds_capture.txt`, `cdb_cmds_slot80.txt`, `cdb_cmds_vtable.txt`, `cdb_cmds_tmwin.txt`) to log:
     - `this` pointer on entry to `PerformSetupAndTransfer`.
     - Vtable slot `0x80` targets (jumping to `TMainWindow::SetupWindow`).
     - Call stacks implicating `InProcessClient32.dll` between `CreateWindowExA` and OWL.
   - `cdb_cmds_esi_trace.txt` + `cdb_esi_trace.log` proved SentinelOne rewrites `esi` to `0x74e01560` (inside `InProcessClient32.dll`) before returning to OWL.

3. **Documentation & handoff materials**
   - `docs/debug_analysis_sentinelone.md`: consolidated evidence and register dumps.
   - `docs/mitigation_plan_sentinelone.md`: ordered plan (IT exemption → guard fallback → smoke/CI).
   - `docs/post_crash_validation_checklist.md`: tasks to execute once runtime stabilizes.
   - Updated running journal (`docs/debug_journal_2025-10-17.md`) and progress summary (`progress_summary_runtime.txt`) with latest findings and artifacts.

4. **Mitigation experiments**
   - Attempted OWL source changes (caching `this`, noinline helper) to survive the hook; MSVC still emitted `mov esi, ecx` prologue, so changes were reverted to avoid diverging from upstream OWL.
   - Verified that without SentinelOne intervention the app should proceed (no other defects detected).

5. **External validation**
   - Surveyed community reports showing `InProcessClient32.dll` causing similar `0xc0000005` crashes (business apps, Microsoft 365, games) that disappear when the agent is removed or rolled back.

## Key Findings
- SentinelOne’s `InProcessClient32.dll` hook clobbers the non-volatile `ESI` register right after `CreateWindowExA`, causing OWL to write through a bogus pointer.
- Every debugger run shows identical behavior: `esi` swapped to an address inside the SentinelOne image, then the crash.
- Compiler-level workarounds in third-party OWL sources are ineffective and risky; the agent must be disabled, bypassed, or guarded externally.

## Current Blocker
- SentinelOne remains enabled with no path-level or process-level exclusions, so runtime debugging cannot proceed without an exemption or a clean environment.

## Recommended Next Actions
1. **Coordinate with security/IT**
   - Add a SentinelOne exclusion for `railc_msvc.exe` (path/process) *or* temporarily disable the agent on this machine.
   - If not possible, spin up a dev VM (Hyper-V, Sandbox, or cloud Windows VM) without the agent.
2. **If exemption delays persist**
   - Implement the diagnostic guard outlined in `docs/mitigation_plan_sentinelone.md` (external hook or shim that restores `ESI`), clearly marked as temporary.
3. **Once SentinelOne is out of the path**
   - Run the smoke checklist and CI jobs per `docs/post_crash_validation_checklist.md`.
   - Record results in `progress_summary_runtime.txt` and archive fresh logs.

## Artifact Index
- Debug logs: `cdb_capture.log`, `cdb_vtable.log`, `cdb_slot80.log`, `cdb_tmwin.log`, `cdb_esi_trace.log`, `cdb_run_after_patch.log`.
- Scripts: `cdb_cmds_capture.txt`, `cdb_cmds_vtable.txt`, `cdb_cmds_slot80.txt`, `cdb_cmds_tmwin.txt`, `cdb_cmds_esi_trace.txt`, `cdb_cmds_run.txt`.
- Documentation: `docs/debug_analysis_sentinelone.md`, `docs/mitigation_plan_sentinelone.md`, `docs/post_crash_validation_checklist.md`, `docs/debug_journal_2025-10-17.md`, `progress_summary_runtime.txt`.
