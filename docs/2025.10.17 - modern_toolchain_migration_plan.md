# Rail Control Modern Toolchain Migration Plan

## 1. Objectives
- **Primary**: Move Rail Control from Borland C++ 5.02 + OWLNext 6.30 to a supported Microsoft Visual C++ (MSVC) toolchain targeting modern Windows (Visual Studio 2022 or newer) while upgrading to the latest stable OWLNext release (currently v7.x) that supports MSVC.
- **Secondary**: Preserve the ability to build and troubleshoot with the legacy Borland stack until feature parity is achieved, minimizing downtime for maintainers.
- **Longer term**: Lay groundwork for additional modernization (WinHelp replacement, Unicode builds, 64-bit readiness) without blocking the core compiler transition.

## 2. Scope & Assumptions
- Codebase remains 32-bit during the initial migration; 64-bit enablement is a follow-on effort.
- Modern OWLNext libraries and headers will be sourced from the official repository (https://github.com/owlnext/owlnext) and built locally with MSVC.
- Legacy dependencies (e.g., CTL3D, `strstrea`, WinHelp) are addressed via shims or replacements only where MSVC compatibility requires it.
- Manual smoke tests described in project guidelines remain the validation baseline; automated tests may be introduced opportunistically.

## 3. Target Toolchain & Outputs
- **Compiler**: MSVC 19.3x (Visual Studio 2022) with Windows 10/11 SDK.
- **Runtime**: Win32 subsystem (`/SUBSYSTEM:WINDOWS`), `/MT` static runtime initially to mirror Borland outputs.
- **OWLNext**: v7.x built as static libraries (`owlcore`, `owlext`, optional `owlfx`) with multi-threaded static runtime.
- **Build Artifacts**: `railc_msvc.exe` (working name), PDB symbols, updated resource binary, packaged Win32 installer optional.

## 4. Migration Phases

### Phase 0 – Preparation (1–2 weeks)
1. **Inventory & Baseline**
   - Capture current Borland build outputs, INI defaults, resource files, and help assets.
   - Freeze a reference branch/tag for regression comparison.
2. **Tooling Setup**
   - Install Visual Studio 2022 with Desktop C++ workload, Windows 10/11 SDK. (_Completed 17 Oct 2025 – VS Community 2022 17.14 installed._)
   - Acquire OWLNext 7.x sources (downloaded `owlnext-7.0.19.zip` from SourceForge).
3. **Automation Hooks**
   - Stand up a CI pipeline (GitHub Actions/Azure DevOps) capable of building with both BC5 (optional offline) and MSVC to support dual-track migration. (_Placeholder workflow committed at `.github/workflows/msvc.yml`._)

### Phase 1 – Library & Infrastructure (2–3 weeks)
1. **Build OWLNext v7.x with MSVC**
   - Built static Win32 libraries (`owl-7.0-v1930-x86-5t.lib`, etc.) using `build\msvc\build_owlnext_msvc.bat` (`nmake -f vc.mak COMPAT=5`, `/MT`). Documented outputs in `docs/environment_readiness.md`.
   - Record include/library paths for consumption by the Rail Control project.
2. **Establish Modern Build System**
   - Created a Visual Studio solution/project under `build/msvc/` (`RailControl.sln`/`RailControl.vcxproj`) that lists all legacy sources, resources, and links against the freshly built OWLNext libraries.
   - Resource compilation (`railc.rc`) included; MSVC build currently fails in Stage 2 because OWLNext v7 rejects the legacy `OWL1_COMPAT`/`OWL2_COMPAT` flags defined in `classdef.h`.
3. **Introduce Dual-Toolchain Layout**
   - Place MSVC-specific configs under `build/msvc/` (props/targets or CMake presets). (_Directory scaffold created._)
   - Add gating in documentation clarifying environment variables (e.g., `OWLNEXT_MSVC_ROOT`).

### Phase 2 – Codebase Porting (4–6 weeks)
1. **Compiler Compatibility Pass**
   - Replace Borland-specific pragmas/macros:
     - Remove `#define pragma(x)` workaround; introduce MSVC-safe alternatives (`#pragma warning` wrappers).
     - Audit uses of `PASCAL`, `far`, `huge` etc.; map to `WINAPI`, remove obsolete qualifiers.
   - Update header inclusions to use modern standard equivalents (e.g., `<strstream>` or `<sstream>` replacement for `strstrea.h`).
   - Ensure all function prototypes use ANSI-compliant signatures (`LPCTSTR` vs. `LPSTR`).
2. **Language Modernization (Minimal)**
   - Enable `/permissive-` to surface non-standard constructs; fix narrow-to-wide conversions, implicit int rules, and pointer casts.
   - Where MSVC rejects legacy constructs (e.g., K&R-style declarations), refactor minimally to ISO C++98-compliant code.
3. **Resource & API Updates**
   - Replace direct `ctl3d` calls with available OWLNext abstractions (`EnableCtl3d`/`DisableCtl3d`) or stub gracefully if library unavailable.
   - Verify Win32 API prototypes align with MSVC headers (e.g., cast `LPSTR` to `LPCSTR` when passing string literals).
4. **Build Fixes**
   - Resolve link errors by adding required system libs (`comdlg32`, `uxtheme`, etc.).
   - Handle name decoration differences (e.g., `_mainCRTStartup`) by ensuring entry point uses standard `WinMainCRTStartup`.

### Phase 3 – Validation & Parity (2–3 weeks)
1. **Functional Smoke Testing**
   - Repeat project’s manual verification: launch app, open dialogs, run simulation with sample `.RCD` files, trigger WinHelp (or confirm graceful failure).
   - Compare rendering output and behaviour with Borland baseline (screenshots, key metrics).
2. **Regression Tracking**
   - Maintain a shared checklist capturing discrepancies (layout jitter, font metrics, timer cadence).
   - Log issues and assign severity; resolve blockers before go/no-go review.
3. **Performance Observation**
   - Measure timer tick responsiveness and CPU usage on reference hardware; ensure MSVC build does not degrade gameplay responsiveness.

### Phase 4 – Cutover & Cleanup (1–2 weeks)
1. **Documentation & Training**
   - Update README/build docs to describe MSVC workflow, prerequisites, and updated smoke-test procedures.
   - Provide quickstart scripts (`build_msvc.bat`, `launch_msvc.bat`) to streamline adoption.
2. **Legacy Toolchain Sunset Criteria**
   - Define a grace period (e.g., 3 months) where Borland build remains supported.
   - Establish exit checklist: all critical bugs fixed, CI green on MSVC, stakeholders sign-off.
3. **Repository Hygiene**
   - Introduce `.gitignore` entries for MSVC artifacts, new `docs/` references, and optionally remove redundant Borland response files once deprecated.

## 5. Cross-Cutting Tasks
- **Static Analysis**: Run `/analyze` or clang-tidy on the MSVC project to catch latent issues; triage findings into follow-up tickets.
- **Help System Strategy**: Document plan to replace WinHelp with HTMLHelp or embedded HTML; not required for initial compiler migration but note compatibility gaps on Windows 11.
- **Unicode & Internationalization**: Keep code ANSI for now; log required changes (TCHAR usage, resource updates) for future phases.
- **Logging**: Refactor hard-coded paths (e.g., `c:\language\railcontrol\ptrack_debug.log`) to use writable per-user directories when implementing MSVC build to avoid UAC conflicts.

## 6. Risks & Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| OWLNext v7 API incompatibilities | Build failures or runtime regressions | Prototype migration on a branch; leverage OWLNext compatibility flags (`OWL5_COMPAT`) and consult upstream docs. |
| Legacy dependencies (ctl3d, WinHelp) unavailable on modern OS | Loss of UI polish/help access | Bundle redistributables where legal; add runtime detection and fallback UI; plan replacement help viewer post-migration. |
| Timer behaviour differences due to MSVC optimizations | Simulation speed drift | Add instrumentation comparing `WorkTime` increments; adjust SkipCount thresholds if necessary. |
| Manual memory management bugs surfacing under new runtime | Crashes, leaks | Use MSVC debug CRT (`/MDd`) during testing to detect overruns; fix issues before release build. |
| Dual toolchain maintenance burden | Extended timelines | Define clear sunset criteria; avoid diverging code paths by using portable macros (`#if defined(_MSC_VER)`). |

## 7. Deliverables
- MSVC solution/project files and supporting build scripts.
- Documented build instructions and troubleshooting guide.
- Updated CI pipeline covering MSVC builds.
- Comparison test report verifying feature parity with Borland build.
- Migration retrospective summarizing lessons learned and remaining debt.

## 8. Success Criteria
- MSVC-built executable passes all current manual smoke tests on Windows 10/11.
- CI produces reproducible MSVC artifacts and symbols.
- OWLNext v7.x integrated with no critical regressions; legacy Borland build optionally retained but no longer primary.
- Stakeholders concur that the modern toolchain is the default path forward, enabling future modernization steps.
