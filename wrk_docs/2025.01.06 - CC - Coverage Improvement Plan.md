# RailControl Coverage Improvement Plan
**Date:** 2025-01-06
**Current Coverage:** ~90%
**Target Coverage:** 98%
**Approach:** Systematic, test-driven, prioritized by impact/effort ratio

---

## Plan Overview

This plan targets **98% line coverage** through 4 phases of progressively increasing complexity. Each phase includes specific test additions with measurable coverage impact.

### Phase Summary
| Phase | Target | Effort | Test Count | Description |
|-------|--------|--------|------------|-------------|
| **Phase 1** | 93-94% | LOW | ~15 tests | Config limits, telemetry, helper functions |
| **Phase 2** | 95-96% | MEDIUM | ~20 tests | Boundary values, parser branches, positive edge cases |
| **Phase 3** | 97-98% | MEDIUM | ~10 tests | File I/O errors, remaining branches |
| **Phase 4** | Document gaps | HIGH | - | Accept BCrypt paths or refactor crypto layer |

**Total Estimated Tests:** 45 new tests
**Total Estimated Effort:** 8-12 hours
**Risk:** LOW - all additions are incremental, non-breaking

---

## Phase 1: Low-Hanging Fruit (Target: +3-4% → 93-94%)

**Objective:** Add straightforward tests for obvious coverage gaps
**Effort:** 2-3 hours
**Tests:** 15 new tests

### 1.1 Config Limit Enforcement Tests (~1.2% coverage gain)
**File:** `tests/gtest/engine_limits_tests.cpp` (NEW)

Add tests for `engine_stub.cpp` lines 38-44 (LoadLayout validation):

```cpp
TEST(EngineLimits, MaxTrainsExceeded)
TEST(EngineLimits, MaxTrainsAtLimit)
TEST(EngineLimits, MaxSectionsExceeded)
TEST(EngineLimits, MaxSectionsAtLimit)
TEST(EngineLimits, MaxRoutesExceeded)
TEST(EngineLimits, MaxRoutesAtLimit)
TEST(EngineLimits, MaxTimetableEntriesExceeded)
TEST(EngineLimits, MaxTimetableEntriesAtLimit)
```

**Approach:**
1. Create test RCD files with counts at/above limits
2. Set restrictive `EngineConfig` values
3. Verify `LoadLayout` returns `ValidationError` with appropriate message
4. Verify successful load at exact limit

**Test Data Needed:**
- `large_layout_500trains.rcd` (exceeds default maxActiveTrains)
- `large_layout_200sections.rcd` (exceeds limits)
- Use RCD file generator or manually craft minimal files

---

### 1.2 Telemetry Emission Tests (~0.3% coverage gain)
**File:** `tests/gtest/telemetry_tests.cpp` (ENHANCE EXISTING)

Add tests for `engine_stub.cpp` line 308 (EmitDiagnostics telemetry sink):

```cpp
TEST(Telemetry, DiagnosticsEmittedToSink)  // NEW
TEST(Telemetry, ClampWarningEmittedToSink) // NEW
```

**Approach:**
1. Create mock `ITelemetrySink` implementation
2. Inject into engine via `CreateEngine`
3. Trigger diagnostics (e.g., dt clamping with large Advance)
4. Verify sink received `DiagnosticsEvent` with correct level/message

**Implementation:**
```cpp
class MockTelemetrySink : public ITelemetrySink {
public:
  std::vector<DiagnosticsEvent> events;
  void Emit(const DiagnosticsEvent& ev) override { events.push_back(ev); }
};
```

---

### 1.3 Helper Function Edge Cases (~0.8% coverage gain)
**File:** `tests/gtest/parser_helpers_tests.cpp` (NEW)

Test uncovered branches in `rcd_repository.cpp` helper functions:

```cpp
TEST(ParserHelpers, ParseFirstIntTokenNegativeValue)
TEST(ParserHelpers, ParseFirstIntTokenZeroValue)
TEST(ParserHelpers, ParseFirstIntTokenNoComma)
TEST(ParserHelpers, ParseFirstIntTokenEmptyString)
TEST(ParserHelpers, TryParseIntLeadingPlus)
TEST(ParserHelpers, TryParseIntVeryLargeValue)
TEST(ParserHelpers, TryParseIntAllDigits)
TEST(ParserHelpers, SplitCSVTrailingComma)
TEST(ParserHelpers, SplitCSVEmptyTokens)
```

**Approach:**
- These are currently private helpers - add tests via `RcdLayoutRepository::Load` with crafted inputs
- OR make helpers testable via internal test header
- Target uncovered branches in lines 32-77 of rcd_repository.cpp

---

### 1.4 Boundary Value Tests (~0.7% coverage gain)
**File:** `tests/gtest/boundary_values_tests.cpp` (NEW)

Test maximum/minimum valid IDs:

```cpp
TEST(BoundaryValues, SectionIdMax999)
TEST(BoundaryValues, SectionIdMin1)
TEST(BoundaryValues, PlatformIdMax999)
TEST(BoundaryValues, SelectorIdMax999)
TEST(BoundaryValues, RouteIdMax999)
TEST(BoundaryValues, LocoIdMax499)
TEST(BoundaryValues, TimetableIdMax499)
```

**Test Data:** Create `boundary_values.rcd` with all IDs at max valid values

---

## Phase 2: Medium Effort Gaps (Target: +2-3% → 95-96%)

**Objective:** Cover remaining parser branches and positive edge cases
**Effort:** 3-4 hours
**Tests:** 20 new tests

### 2.1 Parser Branch Coverage (~1.5% coverage gain)
**File:** `tests/gtest/parser_branch_tests.cpp` (NEW)

Target uncovered branches in section parsing logic:

```cpp
TEST(ParserBranch, GeneralKeyValueFormat) // Test '=' format vs CSV format
TEST(ParserBranch, GeneralMissingKey)
TEST(ParserBranch, RouteWhitespaceRepair) // Lines 243-254 repair logic
TEST(ParserBranch, RouteExactly9Tokens)
TEST(ParserBranch, RouteTokenCountBeforeRepair)
TEST(ParserBranch, SelectorExactly8Fields)
TEST(ParserBranch, OverlapValidPair)
TEST(ParserBranch, LocoYardDisabledUppercase)
TEST(ParserBranch, LocoYardDisabledMixedCase)
TEST(ParserBranch, LocoYardValidStockCode6)
TEST(ParserBranch, LocoYardValidStockCode12)
```

**Approach:**
- Create minimal RCD files exercising each branch
- Focus on lines with multiple conditions (e.g., line 219 selector field count)

---

### 2.2 Positive Edge Cases (~0.8% coverage gain)
**File:** `tests/gtest/positive_edge_cases_tests.cpp` (NEW)

Test valid but unusual layouts:

```cpp
TEST(PositiveEdgeCases, EmptyRouteStages) // All 6 stages = 0
TEST(PositiveEdgeCases, SingleSectionLayout)
TEST(PositiveEdgeCases, MaximumSelectorCount) // 999 selectors
TEST(PositiveEdgeCases, TimetableNextChainLength10) // Long chain
TEST(PositiveEdgeCases, MixedEncodedZeroPrimaryStages)
TEST(PositiveEdgeCases, AllLocosStockCode1)
TEST(PositiveEdgeCases, StartTimeZero)
TEST(PositiveEdgeCases, StopTime2359) // Max valid time
```

**Test Data:** `positive_edge.rcd` with unusual but valid configurations

---

### 2.3 Error Message Format Tests (~0.5% coverage gain)
**File:** Enhance existing `*_messages_tests.cpp` files

Explicitly test error message content:

```cpp
TEST(ValidationMessages, SectionIdOutOfRangeContainsId)
TEST(ValidationMessages, PlatformDuplicateContainsId)
TEST(ValidationMessages, RouteUnknownSelectorContainsIds)
// ... 5-7 more message format assertions
```

**Approach:**
- Verify error messages contain relevant context (IDs, field names, etc.)
- Ensures lines like `"Route " + std::to_string(id) + ": unknown FromSelector"` are fully executed

---

## Phase 3: Advanced Gaps (Target: +1-2% → 97-98%)

**Objective:** Handle difficult-to-test scenarios
**Effort:** 3-4 hours
**Tests:** ~10 tests

### 3.1 File I/O Error Handling (~0.5% coverage gain)
**File:** `tests/gtest/file_io_errors_tests.cpp` (NEW)

Test `rcd_repository.cpp` line 98 (unable to open file):

```cpp
TEST(FileIOErrors, ReadOnlyDirectory) // Windows: Create file in read-only dir
TEST(FileIOErrors, NetworkPathFailure) // UNC path timeout
TEST(FileIOErrors, LongPathFailure) // >260 char path on Windows
```

**Approach (Windows-specific):**
1. Create temporary directory
2. Set directory to read-only
3. Attempt to load RCD file
4. Verify `StatusCode::LayoutError` and message contains "Unable to open"

**Challenge:** Requires platform-specific code, may fail in CI without admin rights

**Fallback:** Document as low-priority edge case if too complex

---

### 3.2 Canonicalization Edge Cases (~0.3% coverage gain)
**File:** `tests/gtest/id_canonicalization_edge_tests.cpp` (NEW)

Test `CanonicalizeRcdContent` edge cases:

```cpp
TEST(IdCanonicalization, OnlyCRCharacters)
TEST(IdCanonicalization, MixedTabsSpacesLeading)
TEST(IdCanonicalization, TrailingWhitespaceEveryLine)
TEST(IdCanonicalization, EmptyLinesAtStart)
TEST(IdCanonicalization, EmptyLinesInMiddle)
```

---

### 3.3 Engine State Transition Edge Cases (~0.4% coverage gain)
**File:** `tests/gtest/engine_state_edge_tests.cpp` (NEW)

Test uncovered engine state transitions:

```cpp
TEST(EngineStateEdge, PauseWhileStopped)
TEST(EngineStateEdge, ResumeWhileStopped)
TEST(EngineStateEdge, StopWhileIdle)
TEST(EngineStateEdge, AdvanceAfterReset)
TEST(EngineStateEdge, SubscribeAfterReset)
```

---

### 3.4 Observer Notification Edge Cases (~0.3% coverage gain)
**File:** `tests/gtest/observer_notification_edge_tests.cpp` (NEW)

```cpp
TEST(ObserverNotificationEdge, SnapshotWithoutState)
TEST(ObserverNotificationEdge, EventsWithEmptyDelta)
TEST(ObserverNotificationEdge, DiagnosticsWithoutTelemetry)
TEST(ObserverNotificationEdge, MultipleObserversPartialFailure)
```

---

## Phase 4: Accept or Refactor (Target: Document gaps)

**Objective:** Address final ~1.5% or document as technical debt
**Effort:** Variable (0 hours if accepting, 8+ hours if refactoring)

### Option A: Accept BCrypt Paths as Untestable (RECOMMENDED)
**Action:** Document in coverage report and `ARCHITECTURE.md`

**Rationale:**
- BCrypt failures (lines 62-69, 75-80, 82-87 in rcd_id.cpp) require OS-level API mocking
- Failure modes (out of memory, crypto provider unavailable) are catastrophic system failures
- Risk is low: SHA-256 is industry-standard, BCrypt is Windows core API
- Cost/benefit of abstraction layer is poor for legacy modernization

**Documentation:**
```markdown
## Known Coverage Gaps

### BCrypt API Error Paths (rcd_id.cpp)
**Lines:** 62-64, 67-70, 76-80, 85-87
**Coverage Impact:** ~1.5%
**Status:** Accepted technical debt
**Rationale:** OS-level crypto failures are untestable without API mocking framework.
Failure modes represent catastrophic system conditions (out of memory, crypto unavailable).
Production risk is negligible; SHA-256 via BCrypt is Windows standard.
```

---

### Option B: Refactor Crypto to Injectable Interface (NOT RECOMMENDED unless architectural goal)
**Effort:** 8-12 hours
**Impact:** Enables 100% RailCore coverage but adds complexity

**Steps:**
1. Define `ICryptoProvider` interface:
   ```cpp
   class ICryptoProvider {
   public:
     virtual std::string ComputeSHA256(const std::string& input) = 0;
   };
   ```

2. Implement `BCryptCryptoProvider` (move existing logic)

3. Create `MockCryptoProvider` for testing:
   ```cpp
   class MockCryptoProvider : public ICryptoProvider {
   public:
     bool shouldFail = false;
     std::string ComputeSHA256(const std::string& input) override {
       if (shouldFail) return "";
       // ... real implementation ...
     }
   };
   ```

4. Inject via `RcdLayoutRepository` constructor

5. Add tests for failure scenarios

**Recommendation:** Only pursue if planning broader dependency injection refactoring

---

## Implementation Schedule

### Week 1: Phase 1 (Low-Hanging Fruit)
- **Day 1-2:** Config limits + telemetry tests (8 tests)
- **Day 3:** Helper function edge cases (9 tests)
- **Day 4:** Boundary value tests (7 tests)
- **Day 5:** Run coverage, verify 93-94% achieved
- **Deliverable:** 24 new tests, ~4% coverage gain

### Week 2: Phase 2 (Medium Effort)
- **Day 1-2:** Parser branch tests (11 tests)
- **Day 3:** Positive edge cases (8 tests)
- **Day 4:** Error message format tests (7 tests)
- **Day 5:** Run coverage, verify 95-96% achieved
- **Deliverable:** 26 new tests, ~3% coverage gain

### Week 3: Phase 3 (Advanced Gaps)
- **Day 1:** File I/O error tests (3 tests)
- **Day 2:** Canonicalization edge cases (5 tests)
- **Day 3:** Engine state edge cases (5 tests)
- **Day 4:** Observer notification edges (4 tests)
- **Day 5:** Run coverage, verify 97-98% achieved
- **Deliverable:** 17 new tests, ~2% coverage gain

### Week 4: Phase 4 & Documentation
- **Day 1-2:** Decide on BCrypt approach (accept vs. refactor)
- **Day 3-4:** Update documentation (ARCHITECTURE.md, coverage reports)
- **Day 5:** Final coverage run, update CI gates to 98%
- **Deliverable:** Updated docs, 98% gate enforced

**Total Estimated Effort:** 15-20 days (3-4 weeks)
**Parallel Work:** Can be done incrementally, doesn't block other development

---

## Success Criteria

### Quantitative
- ✅ `tools/coverage_gate.ps1 -MinLineRate 0.98 -Hard` passes
- ✅ `tools/coverage_merge_gate.ps1 -MinLineRate 0.98 -Hard` passes
- ✅ CI enforces 98% coverage gate
- ✅ 60-70 new tests added (currently 349 → 409-419 tests)

### Qualitative
- ✅ No degradation in test execution time (<2% increase acceptable)
- ✅ All tests follow existing GTest patterns
- ✅ Test data files organized consistently
- ✅ Coverage gaps documented in ARCHITECTURE.md
- ✅ README.md updated with new 98% coverage badge

---

## Risk Mitigation

### Risk: Tests Too Slow
**Mitigation:** Phase 1-2 tests are lightweight; Phase 3 file I/O tests may be slow but minimal count

### Risk: Platform-Specific Failures
**Mitigation:** File I/O tests may fail on non-Windows or CI; guard with platform checks or skip

### Risk: Flaky Tests
**Mitigation:** Avoid timing-dependent tests; use deterministic mocks

### Risk: Coverage Measurement Variance
**Mitigation:** Run coverage multiple times; accept ±0.5% variance

### Risk: Breaking Changes
**Mitigation:** All tests are additive; no source code changes required (except telemetry mock)

---

## Rollback Plan

If coverage improvements cause issues:
1. **Revert test additions** (git revert)
2. **Restore 90% coverage gate** (.github/workflows/msvc.yml)
3. **Document lessons learned** (wrk_docs/retrospective.md)

All changes are isolated to `tests/gtest/` and test data files - zero production code impact.

---

## Appendix A: Test File Naming Conventions

Follow existing patterns:
- `{feature}_{aspect}_tests.cpp` (e.g., `engine_limits_tests.cpp`)
- `{module}_messages_tests.cpp` for error message validation
- `{module}_edge_tests.cpp` for edge cases
- Alphabetical ordering within test files

---

## Appendix B: Coverage Verification Commands

### Run Coverage Locally
```cmd
set COVERAGE=1
set BUILD_GTEST=1
build.cmd Debug
```

### Check Coverage
```powershell
# Single report (RailCoreTests only)
tools\coverage_gate.ps1 -CoberturaXml build\msvc\Debug\coverage.xml -MinLineRate 0.98

# Merged report (RailCoreTests + GTest)
tools\coverage_merge_gate.ps1 -CoberturaXmlA build\msvc\Debug\coverage.xml -CoberturaXmlB build\msvc\Debug\coverage_gtest.xml -MinLineRate 0.98
```

### Parse Coverage XML
```powershell
[xml]$cov = Get-Content build\msvc\Debug\coverage.xml
$lineRate = [double]$cov.coverage.'line-rate'
Write-Host ("Current coverage: {0:P1}" -f $lineRate)
```

---

## Appendix C: New Test Data Files Required

Create in repo root:
- `large_layout_500trains.rcd` (500 LOCOS entries)
- `large_layout_200sections.rcd` (200 SECTIONS entries)
- `boundary_values.rcd` (all IDs at max valid: 999, 499)
- `positive_edge.rcd` (unusual but valid layout)
- `readonly_test.rcd` (for file I/O permission test)

Naming: Follow `{category}_{description}.rcd` pattern

---

## Conclusion

This plan provides a **systematic, low-risk path to 98% coverage** through incremental test additions. Phase 1-2 deliver ~7% coverage gain with straightforward tests, bringing the project to 96-97%. Phase 3 addresses remaining gaps for the final push to 98%.

**Recommended action:** Begin with Phase 1 (config limits + telemetry) for immediate ~4% gain with minimal effort. Evaluate Phase 3 file I/O tests based on platform constraints. Accept BCrypt paths as documented technical debt to avoid over-engineering.

The codebase is **exceptionally well-tested** at 90%; reaching 98% demonstrates best-in-class quality without sacrificing maintainability.
