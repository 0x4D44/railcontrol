# RailControl Code Review Plan

**Date**: 2025-12-01
**Scope**: Complete codebase review
**Reviewer**: Claude (Opus 4.5)

---

## Code Inventory

### RailCore Backend (12 files, ~890 LOC)

**Source Files (3):**
- `src/railcore/engine_stub.cpp` - Engine implementation with state machine
- `src/railcore/persistence/rcd_id.cpp` - SHA-256 layout identification
- `src/railcore/persistence/rcd_repository.cpp` - RCD file loading/validation

**Header Files (9):**
- `include/railcore/engine.h` - IRailEngine interface
- `include/railcore/engine_factory.h` - Factory pattern
- `include/railcore/types.h` - WorldState, Route, Loco, TimetableEntry
- `include/railcore/status.h` - Status codes
- `include/railcore/commands.h` - Command pattern
- `include/railcore/observer.h` - IObserver pattern
- `include/railcore/services.h` - Service interfaces
- `include/railcore/persistence/rcd_repository.h` - Repository interface
- `include/railcore/persistence/rcd_id.h` - ID computation interface

### RailUI Frontend (28 files, ~12,000 LOC)

**Source Files (26):**
- `src/railui/RAILC.CPP` - Main application, TManager, TMainWindow
- `src/railui/LAYOUT.CPP` - Core simulation canvas (4795 lines)
- `src/railui/ARRIVALS.CPP` - Train arrivals window
- `src/railui/DEPARTUR.CPP` - Train departures window
- `src/railui/PLATFORM.CPP` - Platform operations window
- `src/railui/LOCOYARD.CPP` - Locomotive yard window
- `src/railui/TIMETABL.CPP` - Timetable window
- `src/railui/ROUTES.CPP` - Route management
- `src/railui/SECTION.CPP` - Track sections
- `src/railui/SELECTOR.CPP` - Signal/point controls
- `src/railui/PLATDATA.CPP` - Platform data
- `src/railui/LOCOS.CPP` - Locomotive data
- `src/railui/TOOLBAR.CPP` - Toolbar implementation
- `src/railui/TOOLBUTT.CPP` - Toolbar buttons
- `src/railui/STATBAR.CPP` - Status bar
- `src/railui/START.CPP` - Start dialog
- `src/railui/STARTUP.CPP` - Startup logic
- `src/railui/CONFIGUR.CPP` - Configuration dialog
- `src/railui/FINISH.CPP` - Finish/cleanup
- `src/railui/ABOUT.CPP` - About dialog
- `src/railui/CLASSDEF.CPP` - Class definitions
- `src/railui/DEBUGMEMORYGUARD.CPP` - Memory debugging
- `src/railui/ovlpdata.cpp` - Overlap data
- `src/railui/cli_validate.cpp` - CLI validation mode
- `src/railui/stage_telemetry_cache.cpp` - Stage telemetry

**Header Files (27):**
- Corresponding `.H` files for each source
- `src/railui/GENERAL.H` - General definitions
- `src/railui/OWNERSHIP.H` - Ownership patterns
- `src/railui/handleguard.h` - RAII handle guards

### Tests (164 files)

**Smoke Tests (2):**
- `tests/railcore/smoke_main.cpp`
- `tests/railcore/basic_test.cpp`

**GoogleTest Suites (162):**
- Parser & validation tests
- Engine lifecycle tests
- Scheduling tests
- Delta/observer tests
- Route/selector tests
- Platform tests
- Timetable tests
- Command validation tests
- Performance tests

### Build System (10+ files)

- `build.cmd` - Main build script
- `run.cmd` - Run script
- `build/msvc/*.vcxproj` (4) - VS project files
- `build/msvc/build_owlnext_msvc.bat`
- `tools/*.ps1` (4) - Coverage and test scripts
- `tools/*.cmd` (2) - Build utilities

---

## Review Criteria

### 1. Security
- Buffer overflows / bounds checking
- Input validation (especially RCD parsing)
- Resource management (handle leaks)
- Integer overflow potential
- Format string vulnerabilities

### 2. Memory Safety
- RAII usage consistency
- Smart pointer usage
- Manual memory management issues
- Double-free / use-after-free potential
- Memory leak patterns

### 3. Error Handling
- Exception safety
- Error propagation
- Graceful degradation
- Diagnostic messages

### 4. Code Quality
- Code duplication
- Complexity (cyclomatic, nesting)
- Dead code
- Magic numbers / hardcoded values
- Naming consistency

### 5. Thread Safety
- Race conditions
- Mutex usage
- Shared state management

### 6. Performance
- Algorithm efficiency
- Unnecessary allocations
- Hot path optimization opportunities

### 7. Maintainability
- Documentation
- Modularity
- API design
- Test coverage gaps

---

## Review Phases

### Phase 1: RailCore Backend
Focus areas:
- RCD parser security (untrusted input)
- Engine state machine correctness
- SHA-256 ID computation
- Type safety in data structures

### Phase 2: RailUI Frontend
Focus areas:
- GDI resource management
- Window message handling
- Legacy code patterns
- User input handling

### Phase 3: Test Infrastructure
Focus areas:
- Test coverage completeness
- Test quality / assertions
- Edge case coverage
- Mock/stub quality

### Phase 4: Build & Tooling
Focus areas:
- Build reproducibility
- Dependency management
- Script robustness

---

## Execution Strategy

Use parallel agents to review different sections simultaneously:
1. Agent 1: RailCore engine + types
2. Agent 2: RailCore persistence (RCD parser)
3. Agent 3: RailUI main files (RAILC, LAYOUT)
4. Agent 4: RailUI secondary windows
5. Agent 5: Test infrastructure
6. Agent 6: Build system

Consolidate findings into single comprehensive report.
