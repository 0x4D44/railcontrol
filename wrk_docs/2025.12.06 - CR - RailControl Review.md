# RailControl Code Review - 2025-12-06

Scope: first-party code under src/, include/, tests/, tools/. Excluded third_party/ (vendored OWLNext, gtest build outputs). Plan: `wrk_docs/2025.12.06 - CR - Plan.md`.

## High-Severity Findings
1) Pause flag ignored during Advance; simulation keeps running while paused.
   - Evidence: `src/railcore/engine_stub.cpp:315-329` always sets `engineState_` to Running and advances clock without checking for `EngineState::Paused`.
   - Impact: UI pause/CLI pause cannot stop progression; unexpected arrivals/departures and telemetry while user thinks sim is frozen.
   - Fix: early-return when paused (and keep `simulationActive` false); add tests covering paused Advance.

2) Delay globals naming mismatch with contract/tests.
   - Evidence: `src/railcore/engine_stub.cpp:203-210` publishes `delay.thresholdMinutes`/`delay.maintenanceThrough`; test expects `delay.threshold_min` (see `tests/gtest/engine_lifecycle_tests.cpp:74-84`).
   - Impact: GoogleTest DeltaComposition fails; consumers miss threshold telemetry.
   - Fix: align keys with documented/tested schema and add regression test.

3) Snapshots are live references, not immutable copies.
   - Evidence: `src/railcore/engine_stub.cpp:270-273` returns shared pointer to mutable `state_`; subsequent Advance/Command mutates same object.
   - Impact: callers holding a snapshot may see data races/tearing; violates "immutable snapshot" contract.
   - Fix: clone state under lock (or document live semantics and guard with copy-on-read).

## Medium Findings
4) Route stage tokens: non-numeric or missing values are silently dropped.
   - Evidence: `src/railcore/persistence/rcd_repository.cpp:498-520` skips tokens that fail `TryParseInt`, yet route still accepted with zeroed stages.
   - Impact: malformed routes can pass validation, leading to empty paths and inconsistent runtime routing.
   - Fix: treat any non-numeric/absent stage token as validation error; extend parser tests for corrupted stage fields.

5) Incomplete GENERAL validation and silent layout-id failure.
   - Evidence: `src/railcore/persistence/rcd_repository.cpp:184-191` only checks minutes; hours can exceed 23. Layout ID computed at `src/railcore/persistence/rcd_repository.cpp:478-481` but empty ID is not treated as an error.
   - Impact: invalid times (e.g., 2560) accepted; CLI `--print-id` can emit blank IDs while reporting success.
   - Fix: enforce 0000?2359 bounds and fail when `ComputeRcdIdFromContent` returns empty.

6) CLI wildcard with zero matches reports success.
   - Evidence: `src/railui/cli_validate.cpp:160-177` returns empty file list without marking failure; caller exits 0 with no lines when patterns match nothing.
   - Impact: automation may believe validation passed though no files validated.
   - Fix: if expansion yields no files, append failure and set non-zero exit.

7) `TLocos::LocoNumStr` lacks buffer bound.
   - Evidence: `src/railui/LOCOS.CPP:75-82` copies loco number into caller-provided buffer with no length parameter.
   - Impact: potential overflow if caller supplies <7-byte buffer (current callers use larger but API unsafe).
   - Fix: accept buffer length or return std::string; add defensive assertions.

8) Stage telemetry values not clamped.
   - Evidence: `src/railui/LAYOUT.CPP:3946-3967` and `src/railui/TIMETABL.CPP:411-418` store stage/stageIndex/progress without range checks.
   - Impact: malformed telemetry from core could set negative or >5 stage indexes, producing inconsistent UI state.
   - Fix: clamp stage to {0,1,2} and stageIndex to 0-5 before applying; ignore invalid updates.

## Test Coverage Gaps
- Pause semantics: no test asserts that `Advance` while paused is rejected or no-ops (`engine_pause_resume_tests` only checks idempotency).
- CLI: no test for wildcard patterns that match zero files; allows silent success noted above.
- RCD time bounds & layout ID: no tests for hour > 23 or empty layout IDs.
- Snapshot immutability/thread-safety untested.

## Build/Tooling Notes
- `build.cmd` targets Win32 only and runs GoogleTest only when `BUILD_GTEST=1`; default local builds may miss gtest coverage and STRICT is opt-in. Release builds never run tests (see `build.cmd:1-120`).
- `Directory.Build.props` disables NuGet restore for most projects; ensure devs know to enable when adding PackageReferences.

## Suggested Next Steps
1) Fix pause handling and delay globals naming; add regression tests for paused Advance and telemetry keys.
2) Harden RCD validation (stage tokens, time bounds, non-empty IDs) and extend CLI tests for no-match wildcards.
3) Make snapshots immutable or explicitly document live semantics; add concurrency/consistency tests.
4) Consider enforcing gtest + STRICT in CI, and clarify Win32-only build assumption or add x64 config if supported.
